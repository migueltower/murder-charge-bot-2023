name: Combine All CSV Artifacts

on:
  workflow_dispatch:

jobs:
  collect-and-combine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: List and download all artifacts from workflows A, B, C
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir artifacts_raw
          echo "üîç Fetching artifact list from GitHub..."

          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/${{ github.repository }}/actions/artifacts \
            | jq -r '.artifacts[] | select(.expired == false) | "\(.id) \(.name)"' \
            > artifact_list.txt

          while IFS=" " read -r id name; do
            echo "‚¨áÔ∏è Downloading artifact: $name (ID: $id)"
            curl -L -s -H "Authorization: token $GITHUB_TOKEN" \
                 -H "Accept: application/vnd.github+json" \
                 https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$id/zip \
              -o "artifacts_raw/$name.zip"
          done < artifact_list.txt

      - name: Extract all CSVs
        run: |
          mkdir -p extracted_csvs
          for zip in artifacts_raw/*.zip; do
            unzip -o "$zip" '*.csv' -d extracted_csvs/
          done

      - name: Combine all CSVs
        run: |
          COMBINED=combined_charges_$(date +%Y%m%d_%H%M%S).csv
          head -n 1 $(ls extracted_csvs/*.csv | head -n1) > "$COMBINED"
          tail -n +2 -q extracted_csvs/*.csv >> "$COMBINED"
          echo "‚úÖ Combined CSV created: $COMBINED"

      - name: Upload combined CSV
        uses: actions/upload-artifact@v4
        with:
          name: combined-charges-csv
          path: combined_charges_*.csv
