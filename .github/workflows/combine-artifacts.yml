name: Combine All CSV Artifacts

on:
  workflow_dispatch:

jobs:
  combine-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          merge-multiple: true

      - name: Unzip all zipped CSVs
        run: |
          mkdir -p extracted
          find all_artifacts -name "*.zip" -exec unzip -o {} -d extracted \;

      - name: Combine all CSVs into one
        run: |
          mkdir -p combined
          OUTPUT="combined/charges_combined.csv"
          FIRST=1
          for file in extracted/*.csv; do
            if [ $FIRST -eq 1 ]; then
              cat "$file" > "$OUTPUT"
              FIRST=0
            else
              tail -n +2 "$file" >> "$OUTPUT"
            fi
          done
          echo "âœ… Combined CSV saved to $OUTPUT"

      - name: Upload combined CSV
        uses: actions/upload-artifact@v4
        with:
          name: charges_combined
          path: combined/charges_combined.csv
