name: Combine All Scraper CSVs

on:
  workflow_dispatch:

jobs:
  combine-csvs:
    runs-on: ubuntu-latest

    steps:
      - name: Set up directories
        run: |
          mkdir -p downloads extracted combined

      - name: Authenticate with GitHub CLI
        run: echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token

      - name: Download all artifacts from workflows A, B, and C
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          for wf in "Workflow A - Run Scraper" "Workflow B - Continue Scraper" "Workflow C - Continue Scraper"; do
            echo "Fetching runs for $wf"
            gh run list --workflow="$wf" --limit=20 --json databaseId,status,name -q '.[] | select(.status=="completed") | .databaseId' |
            while read -r run_id; do
              echo "Downloading artifacts for run $run_id"
              gh run download "$run_id" --dir downloads || echo "No artifacts found for run $run_id"
            done
          done

      - name: Extract all zips
        run: |
          find downloads -name '*.zip' | while read zipfile; do
            unzip -o "$zipfile" -d extracted/
          done

      - name: Combine all CSVs
        run: |
          if compgen -G "extracted/*.csv" > /dev/null; then
            header_written=false
            for csv in extracted/*.csv; do
              if [ -f "$csv" ]; then
                if [ "$header_written" = false ]; then
                  cat "$csv" > combined/combined_charges.csv
                  header_written=true
                else
                  tail -n +2 "$csv" >> combined/combined_charges.csv
                fi
              fi
            done
          else
            echo "No CSV files found to combine."
          fi

      - name: Upload combined CSV
        if: success() && hashFiles('combined/combined_charges.csv') != ''
        uses: actions/upload-artifact@v4
        with:
          name: combined-charges
          path: combined/combined_charges.csv
