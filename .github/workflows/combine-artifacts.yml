name: Collect and Combine CSVs

on:
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token

      - name: Download recent artifacts
        run: |
          mkdir -p downloads
          runs=$(gh run list --limit 50 --json databaseId -q '.[].databaseId')
          for run_id in $runs; do
            echo "ðŸ”½ Downloading artifacts for run $run_id"
            gh run download "$run_id" -D downloads || echo "âš ï¸ No artifacts for $run_id"
          done

      - name: Extract all zip files
        run: |
          mkdir -p extracted
          find downloads -name '*.zip' -exec unzip -o {} -d extracted \;

      - name: Combine CSVs
        run: |
          header_saved=false
          output_file="combined_charges.csv"
          > $output_file
          for csv in $(find extracted -name '*.csv'); do
            if ! $header_saved; then
              head -n 1 "$csv" > $output_file
              header_saved=true
            fi
            tail -n +2 "$csv" >> $output_file
          done

      - name: Upload combined CSV
        uses: actions/upload-artifact@v4
        with:
          name: combined-charges
          path: combined_charges.csv
