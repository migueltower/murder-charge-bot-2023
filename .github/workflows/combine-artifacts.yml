name: Collect and Combine CSVs

on:
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Set up GitHub CLI
        uses: cli/cli-action@v1
        with:
          version: latest

      - name: Authenticate GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GH_TOKEN }}"

      - name: List and download artifacts
        run: |
          mkdir -p downloads
          runs=$(gh run list --limit 50 --json databaseId -q '.[].databaseId')

          for run_id in $runs; do
            echo "ðŸ”½ Downloading artifacts for run $run_id"
            gh run download "$run_id" -D downloads || echo "âŒ Failed to download from $run_id"
          done

      - name: Extract all zip files
        run: |
          mkdir -p extracted
          find downloads -name '*.zip' -exec unzip -o {} -d extracted \;

      - name: Combine CSVs
        run: |
          header_saved=false
          output_file="combined_charges.csv"
          > $output_file

          for csv in $(find extracted -name '*.csv'); do
            if ! $header_saved; then
              head -n 1 "$csv" > $output_file
              header_saved=true
            fi
            tail -n +2 "$csv" >> $output_file
          done

      - name: Upload combined CSV
        uses: actions/upload-artifact@v4
        with:
          name: combined-charges
          path: combined_charges.csv
