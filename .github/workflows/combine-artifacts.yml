name: Combine All Artifacts

on:
  workflow_dispatch:

jobs:
  combine-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          merge-multiple: true

      - name: Check if any artifacts were downloaded
        run: |
          if [ ! -d "all_artifacts" ] || [ -z "$(ls -A all_artifacts)" ]; then
            echo "❌ No artifacts downloaded. Exiting."
            exit 0
          fi

      - name: Unzip all zipped CSVs
        run: |
          mkdir -p extracted
          find all_artifacts -name "*.zip" -exec unzip -o {} -d extracted \;

      - name: Combine all CSVs into one
        run: |
          mkdir -p combined
          OUTPUT="combined/charges_combined.csv"
          FIRST=1
          for file in extracted/*.csv; do
            if [ $FIRST -eq 1 ]; then
              cat "$file" > "$OUTPUT"
              FIRST=0
            else
              tail -n +2 "$file" >> "$OUTPUT"
            fi
          done
          echo "✅ Combined CSV saved to $OUTPUT"

      - name: Upload combined CSV
        if: success() && hashFiles('combined/charges_combined.csv') != ''
        uses: actions/upload-artifact@v4
        with:
          name: charges_combined
          path: combined/charges_combined.csv
