name: Combine Workflow Artifacts

on:
  workflow_dispatch:

jobs:
  combine-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download all workflow artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { readdirSync } = require('fs');
            const artifact = require('@actions/artifact');
            const { Octokit } = require("@octokit/rest");

            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            const runs = await octokit.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              per_page: 50,
              status: 'success'
            });

            const artifactClient = artifact.create();
            let downloadCount = 0;

            for (const run of runs.data.workflow_runs) {
              const artifacts = await octokit.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: run.id,
              });

              for (const a of artifacts.data.artifacts) {
                if (a.name.endsWith(".zip") || a.name === "charges-output") {
                  console.log(`⬇️ Downloading artifact: ${a.name}`);
                  await exec.exec("gh", [
                    "run", "download",
                    "--repo", `${owner}/${repo}`,
                    "--run-id", `${run.id}`,
                    "--name", a.name
                  ]);
                  downloadCount++;
                }
              }
            }

            if (downloadCount === 0) {
              core.setFailed("No matching artifacts were found to download.");
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Unzip all downloaded zip files
        run: |
          mkdir extracted
          for z in *.zip; do
            unzip -o "$z" -d extracted
          done

      - name: Combine all CSVs
        run: |
          mkdir combined
          head -n 1 extracted/*.csv | head -n 1 > combined/charges_combined.csv
          tail -n +2 -q extracted/*.csv >> combined/charges_combined.csv
          echo "Combined CSV written to combined/charges_combined.csv"

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: charges_combined
          path: combined/charges_combined.csv
