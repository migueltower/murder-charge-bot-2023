name: Combine CSV Artifacts

on:
  workflow_dispatch:

jobs:
  combine-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: Extract all zip files
        run: |
          mkdir -p extracted
          find all_artifacts -name '*.zip' -exec unzip -q -d extracted {} \;

      - name: Combine all CSV files
        run: |
          mkdir -p combined
          HEADER_WRITTEN=false
          OUTPUT_FILE=combined/combined_murder_charges.csv
          touch $OUTPUT_FILE

          for csv in $(find extracted -name '*.csv'); do
            if [ "$HEADER_WRITTEN" = false ]; then
              head -n 1 "$csv" > $OUTPUT_FILE
              HEADER_WRITTEN=true
            fi
            tail -n +2 "$csv" >> $OUTPUT_FILE
          done

      - name: Upload combined CSV
        uses: actions/upload-artifact@v4
        with:
          name: combined_murder_charges
          path: combined/combined_murder_charges.csv
